{% extends 'base.html' %} {% block title %}Pliki - Menedżer kopii zapasowych{%
endblock %} {% block content %}
<div class="mt-4">
  <h1>Pliki kopii zapasowych</h1>

  {% set tasks_with_files = tasks | selectattr('files') | list %} {% if
  tasks_with_files %}
  <div class="accordion" id="tasksAccordion">
    {% for task in tasks_with_files %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading{{ task.id }}">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapse{{ task.id }}"
          aria-expanded="false"
          aria-controls="collapse{{ task.id }}"
        >
          {{ task.name }}{% if task.deleted %} (Usunięte){% endif %} - {{ task.server.name}}{% if task.server.deleted %} (Usunięte){% endif %}
        </button>
      </h2>
      <div
        id="collapse{{ task.id }}"
        class="accordion-collapse collapse"
        aria-labelledby="heading{{ task.id }}"
        data-bs-parent="#tasksAccordion"
      >
        <div class="accordion-body">
          <form method="POST" action="{{ url_for('files.download_files') }}">
            <table class="table table-striped table-hover mb-0">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="select-all"
                      data-task-id="{{ task.id }}"
                    />
                  </th>
                  <th>Nazwa pliku</th>
                  <th>Rozmiar</th>
                  <th>Suma kontrolna</th>
                  <th>Data utworzenia</th>
                </tr>
              </thead>
              <tbody>
                {% for file in task.files %}
                <tr>
                  <td>
                    <input
                      type="checkbox"
                      name="file_ids"
                      value="{{ file.id }}"
                      class="file-checkbox"
                      data-task-id="{{ task.id }}"
                    />
                  </td>
                  <td>{{ file.name }}</td>
                  <td>{{ file.size }}</td>
                  <td>{{ file.checksum }}</td>
                  <td>{{ file.created.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <button type="submit" class="btn btn-success btn-sm mt-2">
              Pobierz zaznaczone
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-center text-muted">Brak zadań z plikami kopii zapasowych.</p>
  {% endif %}
</div>

<script>
  document.querySelectorAll(".select-all").forEach((selectAll) => {
    selectAll.addEventListener("change", () => {
      const taskId = selectAll.dataset.taskId;
      document
        .querySelectorAll(`.file-checkbox[data-task-id='${taskId}']`)
        .forEach((cb) => {
          cb.checked = selectAll.checked;
        });
    });
  });
</script>
{% endblock %}
