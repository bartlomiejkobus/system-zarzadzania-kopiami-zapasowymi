{% extends 'base.html' %} {% block title %}Serwery - Menedżer kopii zapasowych{%
endblock %} {% block content %}
<div class="mt-4">
  <h1>Serwery</h1>

  <div class="mb-3">
    <button class="btn btn-success me-2" id="add-server">Dodaj</button>
    <button class="btn btn-warning me-2" id="edit-server" disabled>
      Edytuj
    </button>
    <button class="btn btn-danger" id="delete-server" disabled>Usuń</button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col"><input type="checkbox" id="select-all" /></th>
          <th scope="col">Nazwa</th>
          <th scope="col">Host (IP / DNS)</th>
          <th scope="col">Port SSH</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        {% if servers %} {% for server in servers %}
        <tr>
          <td>
            <input
              type="checkbox"
              class="select-server"
              data-server-id="{{ server.id }}"
            />
          </td>
          <td>{{ server.name }}</td>
          <td>{{ server.hostname }}</td>
          <td>{{ server.port }}</td>
          <td>
            {% if server.status == "nieaktywny" %}
            <button
              class="btn btn-warning btn-sm"
              onclick="activateServer({{ server.id }})"
            >
              Aktywuj serwer
            </button>
            {% else %}
            <span class="badge bg-success">Aktywny</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="5" class="text-center text-muted">Brak serwerów</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="modal fade" id="addServerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{{ url_for('servers.add') }}">
          <div class="modal-header">
            <h5 class="modal-title">Dodaj serwer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nazwa serwera</label>
              <input type="text" class="form-control" name="name" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Hostname / IP</label>
              <input
                type="text"
                class="form-control"
                name="hostname"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Port SSH</label>
              <input
                type="number"
                class="form-control"
                name="port"
                value="22"
                required
              />
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Anuluj
            </button>
            <button type="submit" class="btn btn-primary">Zapisz</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editServerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" id="edit-server-form">
          <div class="modal-header">
            <h5 class="modal-title">Edytuj serwer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nowa nazwa</label>
              <input
                type="text"
                class="form-control"
                name="name"
                id="edit-server-name"
                required
              />
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Anuluj
            </button>
            <button type="submit" class="btn btn-primary">Zapisz</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <form
    id="delete-form"
    method="POST"
    action="{{ url_for('servers.delete') }}"
  ></form>
  <div
    class="modal fade"
    id="deleteConfirmModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Potwierdzenie usunięcia</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <p id="delete-count-text">
            Czy na pewno chcesz usunąć wybrane serwery? Usunięte zostaną też powiązane z nimi zadania.
          </p>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Anuluj
          </button>
          <button type="button" class="btn btn-danger" id="confirm-delete">
            Usuń
          </button>
        </div>
      </div>
    </div>
  </div>
  <div
    class="modal fade"
    id="activateServerModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aktywacja serwera</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <div id="connection-status" class="mt-2"></div>

          <p>
            Uruchom poniższy skrypt na serwerze, aby aktywować połączenie z
            systemem:
          </p>

          <div class="code-block position-relative mb-3">
            <div
              class="code-header d-flex justify-content-between align-items-center p-1 bg-light border-bottom"
            >
              <span class="fw-bold">bash</span>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="copyCode(this)"
              >
                Skopiuj kod
              </button>
            </div>
            <pre
              class="mb-0"
            ><code class="bash">{{ install_script }}</code></pre>
          </div>
        </div>

        <div class="modal-footer">
          <button
            class="btn btn-primary me-auto"
            id="test-connection-btn"
            onclick="testServerConnection()"
          >
            Sprawdź połączenie
          </button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Zamknij
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block js %}
<script>
  // Pobieranie elementów interfejsu
  const selectAll = document.getElementById("select-all");
  const checkboxes = document.querySelectorAll(".select-server");
  const editBtn = document.getElementById("edit-server");
  const deleteBtn = document.getElementById("delete-server");

  // Zaznaczanie/odznaczanie wszystkich checkboxów
  selectAll.addEventListener("change", () => {
    checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
    updateButtons();
  });

  // Aktualizowanie stanu przycisków (edycja tylko 1 zaznaczony, usuwanie >=1)
  function updateButtons() {
    const anyChecked = Array.from(checkboxes).some((cb) => cb.checked);
    const singleChecked =
      Array.from(checkboxes).filter((cb) => cb.checked).length === 1;

    editBtn.disabled = !singleChecked;
    deleteBtn.disabled = !anyChecked;
  }

  // Reakcja na zmianę zaznaczenia pojedynczego checkboxa
  checkboxes.forEach((cb) => cb.addEventListener("change", updateButtons));

  // Otwieranie modala dodawania serwera
  document.getElementById("add-server").addEventListener("click", () => {
    const modal = new bootstrap.Modal(
      document.getElementById("addServerModal")
    );
    modal.show();
  });

  // Otwieranie modala edycji serwera (tylko gdy zaznaczono dokładnie 1)
  document.getElementById("edit-server").addEventListener("click", () => {
    const checked = Array.from(
      document.querySelectorAll(".select-server")
    ).filter((cb) => cb.checked);

    if (checked.length !== 1) return;

    const serverId = checked[0].dataset.serverId;
    const serverName = checked[0].closest("tr").children[1].innerText;
    
    // Obsługa usuwania serwerów (można zaznaczyć wiele)
    document.getElementById("edit-server-name").value = serverName;
    document.getElementById("edit-server-form").action =
      "/servers/edit/" + serverId;

    const modal = new bootstrap.Modal(
      document.getElementById("editServerModal")
    );
    modal.show();
  });
  document.getElementById("delete-server").addEventListener("click", () => {
    const checked = Array.from(
      document.querySelectorAll(".select-server")
    ).filter((cb) => cb.checked);

    if (checked.length === 0) return;

    const modal = new bootstrap.Modal(
      document.getElementById("deleteConfirmModal")
    );
    modal.show();

    // Po potwierdzeniu dynamicznie tworzymy pola w formularzu i wysyłamy
    document.getElementById("confirm-delete").onclick = () => {
      const form = document.getElementById("delete-form");
      form.innerHTML = "";

      checked.forEach((cb) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "server_ids";
        input.value = cb.dataset.serverId;
        form.appendChild(input);
      });

      form.submit();
    };
  });

  // Kopiowanie przykładowego kodu z bloku <code>
  function copyCode(btn) {
    const code = btn.closest(".code-block").querySelector("code").innerText;
    navigator.clipboard.writeText(code);
    btn.innerText = "Skopiowano!";
    setTimeout(() => (btn.innerText = "Skopiuj kod"), 1500);
  }

  // ID serwera używanego w modalu aktywacji
  let CURRENT_SERVER_ID = null;

  // Otwieranie modala aktywacji serwera
  function activateServer(id) {
    CURRENT_SERVER_ID = id;
    new bootstrap.Modal(document.getElementById("activateServerModal")).show();
  }

    // Testowanie połączenia z serwerem
  function testServerConnection() {
    const btn = document.getElementById("test-connection-btn");
    const statusDiv = document.getElementById("connection-status");
    const modalEl = document.getElementById("activateServerModal");
    const modal = bootstrap.Modal.getInstance(modalEl);

    btn.disabled = true;
    btn.innerText = "Sprawdzanie połączenia...";
    statusDiv.innerHTML = "";

    // Zapytanie POST do endpointu testującego połączenie
    fetch(`/servers/test-connection/${CURRENT_SERVER_ID}`, { method: "POST" })
      .then((res) => res.json())
      .then((data) => {
        // Udane połączenie
        if (data.success) {
          statusDiv.innerHTML =
            '<div class="alert alert-success mb-0">Połączenie udane - serwer aktywowany!</div>';

          // Po zamknięciu modala — odśwież stronę
          modalEl.addEventListener(
            "hidden.bs.modal",
            () => {
              location.reload();
            },
            { once: true }
          );
        } else {
          // Błąd po stronie serwera lub walidacji
          statusDiv.innerHTML = `<div class="alert alert-danger mb-0">
                    Błąd połączenia. Sprawdź czy skrypt został poprawnie wykonany, 
                    dane serwera są poprawne i połączenie jest dostępne.<br>
                </div>`;
        }
      })
      .catch((err) => {
        // Błąd sieciowy
        statusDiv.innerHTML = `<div class="alert alert-danger mb-0">Błąd sieci.</div>`;
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerText = "Sprawdź połączenie";
      });
  }
</script>
{% endblock %}
