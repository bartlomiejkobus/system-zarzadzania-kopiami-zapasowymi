{% extends 'base.html' %} {% block title %}Zadania - Menedżer kopii zapasowych{%
endblock %} {% block content %}
<div class="mt-4">
  <h1>Zadania kopii zapasowych</h1>

  <div class="mb-3">
    <button class="btn btn-success me-2" id="add-task">Dodaj</button>
    <button class="btn btn-warning me-2" id="edit-task" disabled>Edytuj</button>
    <button class="btn btn-danger" id="delete-task" disabled>Usuń</button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col"><input type="checkbox" id="select-all" /></th>
          <th scope="col">Nazwa</th>
          <th scope="col">Serwer</th>
          <th scope="col">Harmonogram</th>
          <th scope="col">Czas retencji</th>
          <th scope="col">Ostatni status</th>
        </tr>
      </thead>
      <tbody>
        {% for task, server in tasks %}
        <tr>
          <td>
            <input
              type="checkbox"
              class="select-task"
              data-task-id="{{ task.id }}"
            />
          </td>
          <td>{{ task.name }}</td>
          <td>{{ server.name }}</td>
          <td>{{ task.schedule }}</td>
          <td>{{ task.retention }} dni</td>
          <td>
            {% if task.last_status == 'sukces' %}
            <span class="text-success">Sukces</span>
            {% elif task.last_status == 'błąd' %}
            <span class="text-danger">Błąd</span>
            {% else %}
            <span class="text-secondary">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form
        class="modal-content"
        method="POST"
        action="{{ url_for('tasks.add') }}"
      >
        <div class="modal-header">
          <h5 class="modal-title">Dodaj zadanie</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nazwa zadania</label>
            <input type="text" name="name" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Serwer</label>
            <select name="server_id" class="form-select" required>
              {% for server in servers %}
              <option value="{{ server.id }}">{{ server.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Harmonogram (cron)</label>
            <input
              type="text"
              name="schedule"
              class="form-control"
              placeholder="np. 0 3 * * *"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Retencja (dni)</label>
            <input
              type="number"
              name="retention"
              class="form-control"
              min="1"
              required
            />
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Anuluj
          </button>
          <button type="submit" class="btn btn-success">Dodaj</button>
        </div>
      </form>
    </div>
  </div>
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="POST" id="edit-task-form">
        <div class="modal-header">
          <h5 class="modal-title">Edytuj zadanie</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Harmonogram (cron)</label>
            <input
              type="text"
              id="edit-schedule"
              name="schedule"
              class="form-control"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Retencja (dni)</label>
            <input
              type="number"
              id="edit-retention"
              name="retention"
              class="form-control"
              min="1"
              required
            />
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Anuluj
          </button>
          <button type="submit" class="btn btn-warning">Zapisz</button>
        </div>
      </form>
    </div>
  </div>
  <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="POST" action="/tasks/delete">
        <div class="modal-header">
          <h5 class="modal-title">Potwierdzenie usunięcia</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <p>Czy na pewno chcesz usunąć wybrane zadania?</p>

          <div id="delete-task-ids"></div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Anuluj
          </button>
          <button type="submit" class="btn btn-danger">Usuń</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block js %}
<script>
  const selectAll = document.getElementById("select-all");
  const checkboxes = document.querySelectorAll(".select-task");
  const editBtn = document.getElementById("edit-task");
  const deleteBtn = document.getElementById("delete-task");

  selectAll?.addEventListener("change", () => {
    checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
    updateButtons();
  });

  function updateButtons() {
    const anyChecked = Array.from(checkboxes).some((cb) => cb.checked);
    const singleChecked =
      Array.from(checkboxes).filter((cb) => cb.checked).length === 1;

    editBtn.disabled = !singleChecked;
    deleteBtn.disabled = !anyChecked;
  }

  checkboxes.forEach((cb) => cb.addEventListener("change", updateButtons));
  document.getElementById("add-task").addEventListener("click", () => {
    const modal = new bootstrap.Modal(document.getElementById("addTaskModal"));
    modal.show();
  });
  document.getElementById("edit-task").addEventListener("click", () => {
    const checked = Array.from(
      document.querySelectorAll(".select-task")
    ).filter((cb) => cb.checked);

    if (checked.length !== 1) return;

    const taskId = checked[0].dataset.taskId;
    const row = checked[0].closest("tr");

    const schedule = row.children[3].innerText.trim();
    const retention = row.children[4].innerText.replace(" dni", "").trim();

    document.getElementById("edit-schedule").value = schedule;
    document.getElementById("edit-retention").value = retention;

    document.getElementById("edit-task-form").action = "/tasks/edit/" + taskId;

    const modal = new bootstrap.Modal(document.getElementById("editTaskModal"));
    modal.show();
  });
  document.getElementById("delete-task").addEventListener("click", () => {
    const checked = Array.from(
      document.querySelectorAll(".select-task")
    ).filter((cb) => cb.checked);

    if (checked.length === 0) return;

    const container = document.getElementById("delete-task-ids");
    container.innerHTML = "";

    checked.forEach((cb) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "task_ids[]";
      input.value = cb.dataset.taskId;
      container.appendChild(input);
    });

    const modal = new bootstrap.Modal(
      document.getElementById("deleteTaskModal")
    );
    modal.show();
  });
</script>
{% endblock %}
